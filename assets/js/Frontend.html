<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Reservasi & Pembayaran</title>
    <!-- Midtrans Snap.js -->
    <script src="https://app.sandbox.midtrans.com/snap/snap.js" data-client-key="Mid-client-70ua3ZN798SZKqf5"></script>
</head>
<body>

<h2>Reservasi Lapangan</h2>

<form id="paymentForm">
    <!-- Jadwal yang dipilih, ganti value sesuai ID jadwal -->
    <input type="hidden" name="jadwal_id" value="123">
    <button type="submit" id="btnBooking">Bayar Sekarang</button>
</form>

<script>
const btnBooking = document.getElementById('btnBooking');
const paymentForm = document.getElementById('paymentForm');

btnBooking.addEventListener("click", async (e) => {
    e.preventDefault();

    btnBooking.disabled = true;
    btnBooking.textContent = 'Memproses...';

    const formData = new FormData(paymentForm);
    formData.append('prosesBayar', '1');

    try {
        const res = await fetch('payment_proses.php', { method: 'POST', body: formData });
        const data = await res.json();

        if (!data.success) {
            alert(data.message || 'Terjadi kesalahan');
            btnBooking.disabled = false;
            btnBooking.textContent = 'Bayar Sekarang';
            return;
        }

        // Snap popup
        snap.pay(data.snap_token, {
            onSuccess: function(result) {
                window.location.href = 'pembayaran_sukses.php?order_id=' + data.order_id;
            },
            onPending: function(result) {
                alert('Pembayaran pending, silakan selesaikan pembayaran Anda');
                window.location.href = 'riwayat_pemesanan.php';
            },
            onError: function(result) {
                alert('Pembayaran gagal. Silakan coba lagi.');
                btnBooking.disabled = false;
                btnBooking.textContent = 'Bayar Sekarang';
            },
            onClose: function() {
                btnBooking.disabled = false;
                btnBooking.textContent = 'Bayar Sekarang';
            }
        });

    } catch (error) {
        alert('Terjadi kesalahan: ' + error.message);
        btnBooking.disabled = false;
        btnBooking.textContent = 'Bayar Sekarang';
    }
});
</script>

</body>
</html>
